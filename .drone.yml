---
kind: pipeline
name: default

platform:
  os: linux
  arch: arm

steps:
  - name: gate-master
    image: bdebyl/alpine-git
    commands:
      - git fetch origin +refs/heads/master
      - git show-ref
      - git diff --name-only HEAD~1..HEAD | grep Dockerfile || exit 78
    when:
      branch:
        - master

  - name: gate-pr
    image: bdebyl/alpine-git
    commands:
      - git fetch origin +refs/heads/master
      - git show-ref
      - git diff --name-only $(git merge-base refs/remotes/origin/master HEAD)..HEAD | grep Dockerfile || exit 78
    when:
      branch:
        exclude:
          - master

  - name: build
    image: bdebyl/hugo
    commands:
      - git clone https://github.com/bdebyl/hugo-theme-even.git themes/even
      - hugo

  - name: deploy
    image: bdebyl/awscli
    environment:
      DISTRIBUTION_ID:
        from_secret: aws_distribution_id
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_key
      AWS_DEFAULT_REGION: us-east-1
    commands:
      - aws s3 sync --acl "public-read" --sse "AES256" public/ s3://bdebyl.net
      - aws cloudfront create-invalidation --distribution-id "$DISTRIBUTION_ID" --paths '/*'
    when:
      branch:
        - master
